{% extends "base.html" %}
{% block title %}Live View â€” Opus NVR{% endblock %}

{% block content %}
<div class="flex items-center justify-between mb-4">
    <h2 class="text-xl font-bold text-white">Live View</h2>
    <div class="flex items-center gap-3">
    <span id="qualityBadge" class="text-xs px-2 py-1 rounded font-medium bg-indigo-900/60 text-indigo-300 border border-indigo-800">
      Main stream
    </span>
        <div class="flex items-center gap-1 bg-gray-800 rounded-lg p-1">
            <button onclick="setGrid(1)" class="grid-btn px-3 py-1.5 rounded text-sm text-gray-400 hover:text-white">1Ã—1</button>
            <button onclick="setGrid(2)" class="grid-btn px-3 py-1.5 rounded text-sm text-white bg-gray-700">2Ã—2</button>
            <button onclick="setGrid(3)" class="grid-btn px-3 py-1.5 rounded text-sm text-gray-400 hover:text-white">3Ã—3</button>
            <button onclick="setGrid(4)" class="grid-btn px-3 py-1.5 rounded text-sm text-gray-400 hover:text-white">4Ã—4</button>
        </div>
        <!-- Pagination -->
        <div class="flex items-center gap-1">
            <button onclick="changePage(-1)" class="px-3 py-1.5 bg-gray-800 hover:bg-gray-700 text-gray-300 rounded text-sm">â€¹</button>
            <span id="pageLabel" class="text-sm text-gray-400 px-2"></span>
            <button onclick="changePage(1)"  class="px-3 py-1.5 bg-gray-800 hover:bg-gray-700 text-gray-300 rounded text-sm">â€º</button>
        </div>
    </div>
</div>
{% endblock %}

{% block full_width %}

{# Pass camera data to JS as JSON â€” no iframes rendered server-side at all #}
<script>
    const ALL_CAMERAS = [
      {% for cam in cameras %}
      { main: "{{ cam.name }}", sub: "{{ sub_map[cam.name] }}", label: "{{ cam.display_name | replace(' â€” ', ' ') | replace(' Main', '') }}", nvr: "{{ cam.nvr.display_name if cam.nvr else '' }}" },
      {% endfor %}
    ];
</script>

{% if cameras %}
<div id="cameraGrid" style="display:grid; grid-template-columns: repeat(2, 1fr); gap: 4px;">
    <!-- Tiles injected by JS -->
</div>
{% else %}
<div class="text-center py-24 text-gray-500 px-6">
    <div class="text-5xl mb-4">ðŸ“·</div>
    <p class="text-lg font-medium text-gray-400">No active cameras</p>
    <p class="text-sm mt-1">
        <a href="{{ url_for('cameras.index') }}" class="text-indigo-400 hover:underline">Add a camera</a>
        to get started.
    </p>
</div>
{% endif %}

<!-- Fullscreen overlay -->
<div id="fsOverlay" class="hidden fixed inset-0 bg-black z-50 flex flex-col">
    <div class="flex items-center justify-between px-4 py-3 bg-gray-900 border-b border-gray-800">
        <span id="fsTitle" class="text-white font-medium"></span>
        <button onclick="closeFullscreen()" class="text-gray-400 hover:text-white text-sm px-3 py-1 border border-gray-700 rounded">
            âœ• Close
        </button>
    </div>
    <div class="flex-1 relative">
        <iframe id="fsFrame" style="position:absolute; inset:0; width:100%; height:100%; border:0;" allow="autoplay"></iframe>
    </div>
</div>

<script>
    const SUB_THRESHOLD = 3;
    let currentCols = 2;
    let currentPage = 0;

    function visibleCount() { return currentCols * currentCols; }

    function totalPages() {
      return Math.max(1, Math.ceil(ALL_CAMERAS.length / visibleCount()));
    }

    function render() {
      const grid = document.getElementById('cameraGrid');
      if (!grid) return;

      const useSub = currentCols >= SUB_THRESHOLD;
      const count  = visibleCount();
      const start  = currentPage * count;
      const slice  = ALL_CAMERAS.slice(start, start + count);

      // â”€â”€ Destroy all existing iframes first so go2rtc drops the connections â”€â”€
      grid.querySelectorAll('iframe').forEach(f => { f.src = ''; });
      grid.innerHTML = '';

      grid.style.gridTemplateColumns = `repeat(${currentCols}, 1fr)`;

      slice.forEach(cam => {
        const streamName = useSub ? cam.sub : cam.main;
        const tile = document.createElement('div');
        tile.className = 'bg-black overflow-hidden group';
        tile.style.position = 'relative';
        tile.dataset.main = cam.main;

        tile.innerHTML = `
          <!-- Camera label overlay (top, on hover) -->
          <div style="position:absolute; top:0; left:0; right:0; z-index:20;
                      background:linear-gradient(to bottom,rgba(0,0,0,0.7),transparent);
                      padding:8px 12px; display:flex; justify-content:space-between; align-items:center;
                      opacity:0; transition:opacity 0.2s;" class="tile-overlay">
            <span style="color:#fff; font-size:13px; font-weight:500; text-shadow:0 1px 3px rgba(0,0,0,0.8);">${cam.label}</span>
            <span style="color:#ccc; font-size:11px;">${cam.nvr}</span>
          </div>

          <!-- Fullscreen button (top-right, on hover) -->
          <button onclick="openFullscreen('${cam.main}','${cam.label}')"
            style="position:absolute; top:8px; right:8px; z-index:30;
                   background:rgba(0,0,0,0.6); color:#fff; border:1px solid #555;
                   border-radius:4px; padding:2px 8px; font-size:12px; cursor:pointer;
                   opacity:0; transition:opacity 0.2s;" class="tile-overlay">
            â›¶
          </button>

          <!-- Click shield â€” blocks all mouse interaction with the iframe -->
          <div style="position:absolute; inset:0; z-index:10; cursor:default;"></div>

          <!-- Stream iframe -->
          <div style="position:relative; padding-bottom:56.25%;">
            <iframe
              style="position:absolute; inset:0; width:100%; height:100%; border:0;"
              src="/go2rtc/stream.html?src=${streamName}&mode=mse"
              allow="autoplay">
            </iframe>
          </div>
        `;

        // Hover show/hide overlays
        tile.addEventListener('mouseenter', () => {
          tile.querySelectorAll('.tile-overlay').forEach(el => el.style.opacity = '1');
        });
        tile.addEventListener('mouseleave', () => {
          tile.querySelectorAll('.tile-overlay').forEach(el => el.style.opacity = '0');
        });

        grid.appendChild(tile);
      });

      // Update page label
      document.getElementById('pageLabel').textContent =
        `${currentPage + 1} / ${totalPages()}`;

      // Update quality badge
      const badge = document.getElementById('qualityBadge');
      badge.textContent = useSub ? 'Sub stream' : 'Main stream';
      badge.className = useSub
        ? 'text-xs px-2 py-1 rounded font-medium bg-yellow-900/60 text-yellow-300 border border-yellow-800'
        : 'text-xs px-2 py-1 rounded font-medium bg-indigo-900/60 text-indigo-300 border border-indigo-800';
    }

    function setGrid(cols) {
      currentCols = cols;
      currentPage = 0;

      document.querySelectorAll('.grid-btn').forEach((btn, i) => {
        const btnCols = [1, 2, 3, 4][i];
        btn.className = btnCols === cols
          ? 'grid-btn px-3 py-1.5 rounded text-sm text-white bg-gray-700'
          : 'grid-btn px-3 py-1.5 rounded text-sm text-gray-400 hover:text-white';
      });

      render();
    }

    function changePage(dir) {
      const next = currentPage + dir;
      if (next < 0 || next >= totalPages()) return;
      currentPage = next;
      render();
    }

    function openFullscreen(streamName, label) {
      document.getElementById('fsTitle').textContent = label;
      document.getElementById('fsFrame').src = `/go2rtc/stream.html?src=${streamName}&mode=mse`;
      document.getElementById('fsOverlay').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    function closeFullscreen() {
      document.getElementById('fsOverlay').classList.add('hidden');
      document.getElementById('fsFrame').src = '';  // kills the stream connection immediately
      document.body.style.overflow = '';
    }

    document.addEventListener('keydown', e => { if (e.key === 'Escape') closeFullscreen(); });

    // Kill all streams when user navigates away
    window.addEventListener('beforeunload', () => {
      document.querySelectorAll('iframe').forEach(f => { f.src = ''; });
    });

    // Initial render
    render();
</script>
{% endblock %}